# Quotio 发布指南

## 快速开始（推荐）

### 选项 1：推送标签（通过 GitHub Actions 自动化）
```bash
# 更新 CHANGELOG.md（可选 - 如果缺少将自动更新）
# 然后推送标签以触发自动发布
git tag v0.5.0
git push origin v0.5.0
```

GitHub Actions 将自动执行：
1. 构建应用
2. 创建 DMG 和 ZIP
3. 使用 Sparkle 签署 appcast
4. 创建 GitHub Release
5. 将版本变更提交回 master

### 选项 2：使用快速发布脚本
```bash
./scripts/quick-release.sh 0.5.0           # 发布 0.5.0
./scripts/quick-release.sh 0.5.0-beta-1    # 发布 beta 版本
./scripts/quick-release.sh patch           # 增加补丁版本并发布
```

### 选项 3：从 GitHub UI 手动触发
1. 前往 **Actions** → **Release** 工作流
2. 点击 **Run workflow**
3. 输入版本（例如 `0.5.0`）
4. 点击 **Run workflow**

---

## 前提条件（一次性设置）

### 1. 添加 GitHub Secret
前往 **Settings** → **Secrets and variables** → **Actions** → **New repository secret**：

| 名称 | 值 |
|------|-------|
| `SPARKLE_PRIVATE_KEY` | 您的 Sparkle EdDSA 私钥 |

要导出您的 Sparkle 私钥：
```bash
./.sparkle/bin/generate_keys -x /tmp/sparkle_key.txt
cat /tmp/sparkle_key.txt
rm /tmp/sparkle_key.txt
```

### 2. 安装本地依赖项（用于本地发布）
```bash
brew install create-dmg
gh auth login
```

### 3. 生成 Sparkle 密钥（如果尚未完成）
```bash
./.sparkle/bin/generate_keys
# 将公钥复制到 Quotio/Info.plist → SUPublicEDKey
```

### 4.（可选）设置公证
```bash
xcrun notarytool store-credentials "quotio-notarization" \
    --apple-id "your@email.com" \
    --team-id "YOUR_TEAM_ID"
```

---

## 发布方法

### GitHub Actions（推荐）

**通过标签推送触发：**
```bash
git tag v0.5.0
git push origin v0.5.0
```

**手动触发：**
- 前往 Actions → Release → Run workflow

**它将执行：**
1. 验证标签格式
2. 更新 CHANGELOG（如果缺少部分，自动移动 [Unreleased]）
3. 在 project.pbxproj 中增加版本号
4. 使用 Xcode 16 构建
5. 创建 ZIP 和 DMG 包
6. 使用 Sparkle 签署 appcast
7. 创建带有资源的 GitHub Release
8. 将版本变更提交回 master

### 本地发布（备用）

```bash
./scripts/release.sh patch   # 0.0.1 → 0.0.2
./scripts/release.sh minor   # 0.0.2 → 0.1.0
./scripts/release.sh major   # 0.1.0 → 1.0.0
./scripts/release.sh 1.2.3   # 设置特定版本
```

---

## Beta/预发布

```bash
./scripts/quick-release.sh 1.2.0-beta-1    # 第一个 beta
./scripts/quick-release.sh 1.2.0-beta-2    # 第二个 beta
```

Beta 版本：
- 在 GitHub 上标记为预发布
- 在 appcast.xml 中包含 `<sparkle:channel>beta</sparkle:channel>`
- 仅对通过 Settings → Updates → Update Channel → Beta 选择加入的用户可见
- 使用 beta 应用图标（黄色 "BETA" 横幅）

---

## 脚本参考

| 脚本 | 用途 |
|--------|---------|
| `scripts/quick-release.sh` | 交互式发布辅助（标签 + 推送） |
| `scripts/bump-version.sh` | 更新项目中的版本 |
| `scripts/build.sh` | 构建发布存档 |
| `scripts/package.sh` | 创建 ZIP 和 DMG |
| `scripts/update-changelog.sh` | 自动更新 CHANGELOG |
| `scripts/generate-appcast.sh` | 生成 appcast（本地，使用 Keychain） |
| `scripts/generate-appcast-ci.sh` | 生成 appcast（CI，使用环境变量） |
| `scripts/notarize.sh` | Apple 公证（可选） |
| `scripts/release.sh` | 完整的本地工作流 |

---

## 版本命名

遵循 [语义化版本](https://semver.org/)：
- **MAJOR** (1.0.0)：重大变更
- **MINOR** (0.1.0)：新功能，向后兼容
- **PATCH** (0.0.1)：错误修复
- **BETA** (1.0.0-beta-1)：用于测试的预发布版本

---

## 故障排除

### GitHub Actions 失败
- 检查 **Actions** 选项卡中的错误日志
- 验证 `SPARKLE_PRIVATE_KEY` 密钥是否正确设置
- 确保标签格式为 `v*`（例如 `v0.5.0`）

### "No Team Found in Archive"
如果没有 Apple Developer ID，这是正常的。构建脚本会自动处理此情况。

### 本地 Appcast 生成期间出现 Keychain 提示
点击"始终允许"以让 Sparkle 访问签名密钥。

### 首次启动时的 Gatekeeper 警告
这是未签名应用的预期行为。用户可以右键点击 → 打开来绕过。

### 版本变更未提交
检查 `[skip ci]` 是否工作。工作流使用此标记来防止无限循环。

---

## 发布检查清单

**发布前：**
- [ ] 所有更改已提交并推送
- [ ] CHANGELOG.md 已更新（或将自动更新）

**标签推送后：**
- [ ] GitHub Actions 工作流已启动
- [ ] 构建成功
- [ ] 已创建带有 DMG、ZIP、appcast.xml 的 GitHub Release
- [ ] 版本变更已提交到 master

**验证：**
- [ ] 下载并测试 DMG
- [ ] 检查自动更新是否有效（Sparkle）
